<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		

<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Re: [請益] php 如何實現crontab 的功能 - 看板 PHP - 批踢踢實業坊</title>
<meta name="robots" content="all">
<meta name="keywords" content="Ptt BBS 批踢踢">
<meta name="description" content="我在想可不可以弄個
cron.php
&lt;?php
set_time_limit(0);
ignore_user_abort(true);
">
<meta property="og:site_name" content="Ptt 批踢踢實業坊">
<meta property="og:title" content="Re: [請益] php 如何實現crontab 的功能">
<meta property="og:description" content="我在想可不可以弄個
cron.php
&lt;?php
set_time_limit(0);
ignore_user_abort(true);
">
<link rel="canonical" href="https://www.ptt.cc/bbs/PHP/M.1192332714.A.2C6.html">

<link rel="stylesheet" type="text/css" href="//images.ptt.cc/bbs/v2.27/bbs-common.css">
<link rel="stylesheet" type="text/css" href="//images.ptt.cc/bbs/v2.27/bbs-base.css" media="screen">
<link rel="stylesheet" type="text/css" href="//images.ptt.cc/bbs/v2.27/bbs-custom.css">
<link rel="stylesheet" type="text/css" href="//images.ptt.cc/bbs/v2.27/pushstream.css" media="screen">
<link rel="stylesheet" type="text/css" href="//images.ptt.cc/bbs/v2.27/bbs-print.css" media="print">




	<script async src='/cdn-cgi/challenge-platform/h/g/scripts/invisible.js?ts=1653465600'></script></head>
    <body>
		
<div id="topbar-container">
	<div id="topbar" class="bbs-content">
		<a id="logo" href="/bbs/">批踢踢實業坊</a>
		<span>&rsaquo;</span>
		<a class="board" href="/bbs/PHP/index.html"><span class="board-label">看板 </span>PHP</a>
		<a class="right small" href="/about.html">關於我們</a>
		<a class="right small" href="/contact.html">聯絡資訊</a>
	</div>
</div>
<div id="navigation-container">
	<div id="navigation" class="bbs-content">
		<a class="board" href="/bbs/PHP/index.html">返回看板</a>
		<div class="bar"></div>
	</div>
</div>
<div id="main-container">
    <div id="main-content" class="bbs-screen bbs-content"><div class="article-metaline"><span class="article-meta-tag">作者</span><span class="article-meta-value">buganini (霸格尼尼)</span></div><div class="article-metaline-right"><span class="article-meta-tag">看板</span><span class="article-meta-value">PHP</span></div><div class="article-metaline"><span class="article-meta-tag">標題</span><span class="article-meta-value">Re: [請益] php 如何實現crontab 的功能</span></div><div class="article-metaline"><span class="article-meta-tag">時間</span><span class="article-meta-value">Sun Oct 14 11:31:52 2007</span></div>
我在想可不可以弄個
cron.php
&lt;?php
set_time_limit(0);
ignore_user_abort(true);

if($sock=stream_socket_server(&#39;udp://0.0.0.0:9999&#39;,
                        $en, $es, STREAM_SERVER_BIND)){
        while(1){
                $now=time();

                #SELECT `id`,`cmd` FROM `crontab` WHERE `next`&lt;=$now;
                #UPDATE `crontab` SET `next`=blah;
                #exec(cmd);

                sleep(300-time()+$now);
        }
}
?&gt;

然後只要用browser去連他一下就ok了
這裡用socket來做lock避免重複執行
(一時間想不到其他方法, 這樣應該可以吧?)
但是他掛掉的時候你得自己再去起動他

但是要儘量減短每個指令需要的時間
因為這沒跑thread
弄不好會拖很久

阿不然就是再弄個
thread.php
&lt;?php
set_time_limit(0);
ignore_user_abort(true);
if($_SERVER[&#39;REMOTE_ADDR&#39;]!=&#39;127.0.0.1&#39;){
        die();
}
#SELECT `cmd` FROM `crontab` WHERE `id`=$_GET[&#39;id&#39;];
#exec(cmd);
?&gt;
然後cron.php那裡用Curl連thread.php?id=X
並且curl timeout設短一些

也不一定要用udp
有unix://可以用的話應該會更好
tcp也是可以
只是我猜想udp消耗的資源應該會&lt;=tcp
只是猜想

以上兩個合成一頁也是OK

剛剛爬到以前的
3517 1 5/19 foxzgerald   R: [閒聊] ignore_user_abort()

其實裡面有一點想法了
可是少了一個重點

如果我記的沒錯的話
要產生一個background process
事實上是執行A      (a)
然後A fork出 B     (b)
然後A自己結束掉    (c)
B變成斷線風箏
這時B就是一個background process

這裡(a)就是cron.php去執行curl的動作 (雖然不是獨立process,但可接受啦)
    (b)是Curl做的事
    (c)用timeout達成


<span class="f2">※ 編輯: buganini        來自: 221.169.71.109       (10/14 11:54)
</span><div class="push"><span class="f1 hl push-tag">→ </span><span class="f3 hl push-userid">buganini</span><span class="f3 push-content">:<a href="http://www.phpclasses.org/browse/package/1136.html" target="_blank" rel="noreferrer noopener nofollow">http://www.phpclasses.org/browse/package/1136.html</a></span><span class="push-ipdatetime"> 10/14 11:58
</span></div><div class="push"><span class="f1 hl push-tag">→ </span><span class="f3 hl push-userid">buganini</span><span class="f3 push-content">:這不知道能不能用</span><span class="push-ipdatetime"> 10/14 11:58
</span></div><div class="push"><span class="hl push-tag">推 </span><span class="f3 hl push-userid">gpmm</span><span class="f3 push-content">:push!!</span><span class="push-ipdatetime"> 10/14 13:34
</span></div><span class="f2">※ 編輯: buganini        來自: 221.169.71.109       (10/14 14:03)
</span><div class="push"><span class="hl push-tag">推 </span><span class="f3 hl push-userid">arzbar</span><span class="f3 push-content">:感恩 小弟這邊先感謝  先消化一下</span><span class="push-ipdatetime"> 10/14 23:35
</span></div><div class="push"><span class="hl push-tag">推 </span><span class="f3 hl push-userid">arzbar</span><span class="f3 push-content">:非常感謝 我消化完後  決定先用下次執行時間來處理</span><span class="push-ipdatetime"> 10/14 23:40
</span></div><div class="push"><span class="f1 hl push-tag">→ </span><span class="f3 hl push-userid">arzbar</span><span class="f3 push-content">:後續有何發展  我會PO 上</span><span class="push-ipdatetime"> 10/14 23:41
</span></div><span class="f2">※ 編輯: buganini        來自: 221.169.71.109       (10/16 12:48)
</span><div class="push"><span class="hl push-tag">推 </span><span class="f3 hl push-userid">buganini</span><span class="f3 push-content">:補充一下, 一定要拿個變數去收他, 不然會always true</span><span class="push-ipdatetime"> 10/16 12:49
</span></div><div class="push"><span class="f1 hl push-tag">→ </span><span class="f3 hl push-userid">buganini</span><span class="f3 push-content">:reference跟value的差別</span><span class="push-ipdatetime"> 10/16 12:51
</span></div></div>
    
    <div id="article-polling" data-pollurl="/poll/PHP/M.1192332714.A.2C6.html?cacheKey=2148-469797157&amp;offset=2560&amp;offset-sig=d6736abbbf280030f5c963ceff0df8563514a181" data-longpollurl="/v1/longpoll?id=f76481bb0e1adcedb8ed782cb26f2a117c4c788d" data-offset="2560"></div>
    

    
</div>

		

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-32365737-1', {
    cookieDomain: 'ptt.cc',
    legacyCookieDomain: 'ptt.cc'
  });
  ga('send', 'pageview');
</script>


		
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="//images.ptt.cc/bbs/v2.27/bbs.js"></script>

    <script type="text/javascript">(function(){window['__CF$cv$params']={r:'710ceabceb2614d0',m:'0NpSMmStSmqN3ioRuSEOcgxxQ6vKDadabzm2EvmmMSQ-1653467509-0-ASraIpFDut6v/XrzKZnz8Sow7rvN6j5esniOFhJNomcrNqPk327PCfc+nWWk1DV8vEizSP2kt1ccRhrM88kyvYS6gB4LjgzHIM6Cw88t56dBLuNaAeABX/XU3FhpnBaKNqcCdHr23ePQr80FkqS7V9x1QjoFkNJkveOw4k6G0Gss',s:[0xfee3cd0dfd,0x5ade2bfefd],u:'/cdn-cgi/challenge-platform/h/g'}})();</script></body>
</html>
